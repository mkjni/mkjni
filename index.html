<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note Taking App</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAY8V41ljl49giypJPu3mCYI_HGLS7vPTY",
            authDomain: "mkjni.github.io",
            projectId: "notepad-78a55",
            storageBucket: "notepad-78a55.appspot.com",
            messagingSenderId: "1040846932668",
            appId: "1:1040846932668:web:03eb48e48e7b7e3ade5eb9",
            measurementId: "G-FX89GV616E"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', (event) => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    loadNotes();
                    document.getElementById('googleSignIn').style.display = 'none';
                } else {
                    document.getElementById('googleSignIn').style.display = 'block';
                }
            });
        });

        document.getElementById('googleSignIn').onclick = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    console.log('User signed in:', result.user);
                    loadNotes();
                })
                .catch((error) => {
                    console.error('Error during sign-in:', error);
                    alert(`Error during sign-in: ${error.message}`);
                });
        };

        function format(command) {
            document.execCommand(command, false, null);
        }

        async function saveNote() {
            const noteContent = document.getElementById('note').innerHTML;
            const user = auth.currentUser;
            if (user) {
                try {
                    await addDoc(collection(db, 'notes'), {
                        uid: user.uid,
                        content: noteContent,
                        timestamp: serverTimestamp()
                    });
                    loadNotes();
                } catch (error) {
                    console.error("Error adding document:", error);
                    alert(`Error adding document: ${error.message}`);
                }
            } else {
                alert("Please sign in first.");
            }
        }

        async function loadNotes() {
            const user = auth.currentUser;
            if (user) {
                try {
                    const q = query(collection(db, 'notes'), where('uid', '==', user.uid), orderBy('timestamp', 'desc'));
                    const querySnapshot = await getDocs(q);
                    const notesList = document.getElementById('notesList');
                    notesList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const note = doc.data().content;
                        const noteDiv = document.createElement('div');
                        noteDiv.className = 'saved-note';
                        noteDiv.innerHTML = `
                            <div class="note-content">${note}</div>
                            <button onclick="deleteNote('${doc.id}')">Delete</button>
                        `;
                        notesList.appendChild(noteDiv);
                    });
                } catch (error) {
                    console.error("Error loading documents:", error);
                    alert(`Error loading documents: ${error.message}`);
                }
            }
        }

        async function deleteNote(id) {
            try {
                await deleteDoc(doc(db, 'notes', id));
                loadNotes();
            } catch (error) {
                console.error("Error removing document:", error);
                alert(`Error removing document: ${error.message}`);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadNotes();
                document.getElementById('googleSignIn').style.display = 'none';
            } else {
                document.getElementById('googleSignIn').style.display = 'block';
            }
        });
    </script>
</head>
<body>
    <div id="app">
        <h1>Note Taking App</h1>
        <button id="googleSignIn">Sign in with Google</button>
        <div id="editor">
            <div>
                <button onclick="format('bold')">Bold</button>
                <button onclick="format('insertUnorderedList')">UL</button>
                <button onclick="format('insertOrderedList')">OL</button>
            </div>
            <div contenteditable="true" id="note" class="note"></div>
            <button onclick="saveNote()">Save Note</button>
        </div>
        <div id="notesList"></div>
    </div>
</body>
</html>
